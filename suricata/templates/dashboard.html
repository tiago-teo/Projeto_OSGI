<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link rel="apple-touch-icon" sizes="76x76" href="../static/assets/img/apple-icon.png">
  <link rel="icon" type="image/png" href="../static/assets/img/favicon.png">
  <title>
    Dashboard
  </title>
  <!--     Fonts and icons     -->
  <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,600,700" rel="stylesheet" />
  <!-- Nucleo Icons -->
  <link href="https://demos.creative-tim.com/argon-dashboard-pro/assets/css/nucleo-icons.css" rel="stylesheet" />
  <link href="https://demos.creative-tim.com/argon-dashboard-pro/assets/css/nucleo-svg.css" rel="stylesheet" />
  <!-- Font Awesome Icons -->
  <script src="https://kit.fontawesome.com/42d5adcbca.js" crossorigin="anonymous"></script>
  <!-- CSS Files -->
  <link id="pagestyle" href="../static/assets/css/argon-dashboard.css?v=2.1.0" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js@2.9.4/dist/Chart.min.js"></script>
</head>

<body class="g-sidenav-show   bg-gray-100">
  <div class="min-height-300 bg-dark position-absolute w-100"></div>
  
  <main class="main-content position-relative border-radius-lg ">
    <!-- Navbar -->
    <nav class="navbar navbar-main navbar-expand-lg px-0 mx-4 shadow-none border-radius-xl " id="navbarBlur" data-scroll="false">
      <div class="container-fluid py-1 px-3">
        <nav aria-label="breadcrumb">
          <h3 class="font-weight-bolder text-white mb-0">Dashboard</h3>
        </nav>
    </nav>
    <!-- End Navbar -->
    <div class="container-fluid py-4">
      <div class="row">
        <div class="col-xl-3 col-sm-6 mb-xl-0 mb-4">
          <div class="card">
            <div class="card-body p-3">
              <div class="row">
                <div class="col-8">
                  <div class="numbers">
                    <p class="text-sm mb-0 text-uppercase font-weight-bold">Tráfego total</p>
                    <h5 id="total_requests" class="font-weight-bolder">
                      {{ total_requests}}
                    </h5>
                  </div>
                </div>
                <div class="col-4 text-end">
                  <div class="icon icon-shape bg-gradient-primary shadow-primary text-center rounded-circle">
                    <i class="ni ni-sound-wave text-lg opacity-10" aria-hidden="true"></i>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-xl-3 col-sm-6 mb-xl-0 mb-4">
          <div class="card">
            <div class="card-body p-3">
              <div class="row">
                <div class="col-8">
                  <div class="numbers">
                    <p class="text-sm mb-0 text-uppercase font-weight-bold">Total IPs</p>
                    <h5 id="num_unique_ips" class="font-weight-bolder">
                      {{ num_unique_ips }}
                    </h5>
                  </div>
                </div>
                <div class="col-4 text-end">
                  <div class="icon icon-shape bg-gradient-danger shadow-danger text-center rounded-circle">
                    <i class="ni ni-world text-lg opacity-10" aria-hidden="true"></i>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-xl-3 col-sm-6 mb-xl-0 mb-4">
          <div class="card">
            <div class="card-body p-3">
              <div class="row">
                <div class="col-8">
                  <div class="numbers">
                    <p class="text-sm mb-0 text-uppercase font-weight-bold">IPs Anormais</p>
                    <h5 id="num_anomalous_ips" class="font-weight-bolder">
                      {{ num_anomalous_ips }}
                    </h5>
                  </div>
                </div>
                <div class="col-4 text-end">
                  <div class="icon icon-shape bg-gradient-success shadow-success text-center rounded-circle">
                    <i class="ni ni-notification-70 text-lg opacity-10" aria-hidden="true"></i>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-xl-3 col-sm-6">
          <div class="card">
            <div class="card-body p-3">
              <div class="row">
                <div class="col-8">
                  <div class="numbers">
                    <p class="text-sm mb-0 text-uppercase font-weight-bold">IPs Bloqueados</p>
                    <h5 id="num_blocked_ips" class="font-weight-bolder">
                      {{ num_blocked_ips }}
                    </h5>
                  </div>
                </div>
                <div class="col-4 text-end">
                  <div class="icon icon-shape bg-gradient-warning shadow-warning text-center rounded-circle">
                    <i class="ni ni-paper-diploma text-lg opacity-10" aria-hidden="true"></i>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="row mt-5">
        <div class="col-lg-7 mb-lg-0 mb-4">
          <div class="card z-index-2 h-100">
            <div class="card-header pb-0 pt-3 bg-transparent">
              <h6 class="text-capitalize">Pacotes recebidos nos últimos 30segundos</h6>
              <p class="text-sm mb-0">
                <i class="fa fa-arrow-up text-success"></i>
                <span class="font-weight-bold">(Pacotes/seg)</span>
              </p>
            </div>
            <div class="card-body p-3">
              <div class="chart">
                <canvas id="chart-line" class="chart-canvas" height="300"></canvas>
              </div>
            </div>
          </div>
        </div>
        
        
        <div class="col-lg-5 mb-lg-0 mb-4">
          <div class="card ">
            <div class="card-header pb-0 p-3">
              <div class="d-flex justify-content-between">
                <h6 class="mb-2">Descrição</h6>
              </div>
            </div>
            <div class="table-responsive">
              <table class="table align-items-center ">
                <tbody id="ip-table-body">
                  {% for ipdata in IPdata %}
                  <tr>
                    <td class="w-30">
                      <div class="d-flex px-2 py-1 align-items-center">
                        <div class="ms-4">
                          <p class="text-xs font-weight-bold mb-0">IP:</p>
                          <h6 class="text-sm mb-0">{{ ipdata.ip }}</h6>
                        </div>
                      </div>
                    </td>
                    <td>
                      <div class="text-center">
                        <p class="text-xs font-weight-bold mb-0">Número de pacotes (30seg):</p>
                        <h6 class="text-sm mb-0">{{ ipdata.num_packets_30s }}</h6>
                      </div>
                    </td> 
                    <td>
                      <div class="text-center">
                        <p class="text-xs font-weight-bold mb-0">Total pacotes:</p>
                        <h6 class="text-sm mb-0">{{ ipdata.num_packets }}</h6>
                      </div>
                    </td>
                    <td class="align-middle text-sm">
                      <div class="col text-center">
                        <p class="text-xs font-weight-bold mb-0">Maligno:</p>
                        <h6 class="text-sm mb-0">{{ ipdata.maligno }}</h6>
                      </div>
                    </td>
                  </tr>
                  {% endfor %}

                </tbody>
              </table>
            </div>
          </div>
        </div>
        <div class="row mt-7">
        <div class="col-lg-12 d-flex justify-content-center">
         <button class="btn btn-icon btn-primary" type="button" action="/" onclick="location.reload();">
            <span class="btn-inner--icon"><i class="ni ni-active-40"></i></span>
            <span class="btn-inner--text"> Refresh</span>
        </button>
          </div>
        </div>
      </div>
      </div>
      <footer class="footer pt-3  ">
        <div class="container-fluid">
          <div class="row align-items-center justify-content-lg-between">
          </div>
        </div>
      </footer>
    </div>
  </main>
  
  <!--   Core JS Files   -->
  <script src="../static/assets/js/core/popper.min.js"></script>
  <script src="../static/assets/js/core/bootstrap.min.js"></script>
  <script src="../static/assets/js/plugins/perfect-scrollbar.min.js"></script>
  <script src="../static/assets/js/plugins/smooth-scrollbar.min.js"></script>
  <script src="../static/assets/js/plugins/chartjs.min.js"></script>
  <script>
    const ctx = document.getElementById("chart-line").getContext("2d");

    // Função para gerar gradientes dinamicamente
    function createGradient(color) {
    const gradient = ctx.createLinearGradient(0, 230, 0, 50);
    gradient.addColorStop(1, color.replace("1)", "0.2)"));
    gradient.addColorStop(0.2, color.replace("1)", "0.0)"));
    gradient.addColorStop(0, color.replace("1)", "0)"));
    return gradient;
    }

    // Lista de cores base (rgba com opacidade 1)
    const baseColors = [
    "rgba(94, 114, 228, 1)",   // Azul
    "rgba(255, 99, 132, 1)",   // Vermelho
    "rgba(75, 192, 192, 1)",   // Verde água
    "rgba(255, 206, 86, 1)",   // Amarelo
    "rgba(153, 102, 255, 1)",  // Roxo
    "rgba(255, 159, 64, 1)",   // Laranja
    "rgba(54, 162, 235, 1)",   // Azul claro
    "rgba(100, 255, 218, 1)",  // Ciano
    "rgba(201, 203, 207, 1)",  // Cinza
    "rgba(0, 200, 83, 1)",     // Verde limão
    ];

    // Armazena os gradientes já criados
    const gradients = baseColors.map(color => createGradient(color));

    const chart = new Chart(ctx, {
    type: "line",
    data: {
      labels: [], // preenchido depois
      datasets: [] // preenchido dinamicamente
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          display: true,
          position: 'bottom'
        }
      },
      interaction: {
        intersect: false,
        mode: 'index',
      },
      scales: {
        y: {
          grid: {
            drawBorder: false,
            display: true,
            drawOnChartArea: true,
            drawTicks: false,
            borderDash: [5, 5]
          },
          ticks: {
            padding: 10,
            color: '#666',
            font: {
              size: 11,
              family: "Open Sans"
            }
          }
        },
        x: {
          grid: {
            drawBorder: false,
            display: false
          },
          ticks: {
            color: '#666',
            padding: 20,
            font: {
              size: 11,
              family: "Open Sans"
            }
          }
        }
      }
    }
    });

    function updateChart(data) {
    const sortedIPs = Object.entries(data)
      .sort((a, b) => b[1].reduce((x, y) => x + y, 0) - a[1].reduce((x, y) => x + y, 0));

    chart.data.datasets = sortedIPs.map(([ip, values], index) => {
      const colorIndex = index % gradients.length;
      return {
        label: ip,
        data: values,
        tension: 0.4,
        borderColor: baseColors[colorIndex],
        backgroundColor: gradients[colorIndex],
        fill: true,
        pointRadius: 0,
        borderWidth: 3,
      };
    });

    // Atualiza labels com base no maior dataset
    const maxLen = Math.max(...sortedIPs.map(entry => entry[1].length));
    chart.data.labels = Array.from({ length: maxLen }, (_, i) => {
      const secondsAgo = maxLen - i - 1;
      const now = new Date();
      now.setSeconds(now.getSeconds() - secondsAgo);
      return now.toTimeString().slice(0, 8); // HH:MM:SS
    });
    chart.update();
    }

    // Primeira carga + atualizações a cada 30s
    function fetchDataAndUpdateChart() {
    fetch('/data')
      .then(response => response.json())
      .then(data => updateChart(data))
      .catch(err => console.error('Erro ao atualizar gráfico:', err));
    }

    fetchDataAndUpdateChart(); // inicial
    setInterval(fetchDataAndUpdateChart, 5000); // 10 segundos

  </script>
  <script>
  // Função para atualizar as estatísticas
  function updateStats() {
      fetch('/stats')
        .then(res => {
          if (!res.ok) throw new Error("Erro no fetch: " + res.status);
          return res.json();
        })
        .then(response => {
          const el1 = document.querySelector('#total_requests');
          const el2 = document.querySelector('#num_unique_ips');
          const el3 = document.querySelector('#num_anomalous_ips');
          const el4 = document.querySelector('#num_blocked_ips');

          if (el1) el1.innerText = response.total_requests;
          if (el2) el2.innerText = response.num_unique_ips;
          if (el3) el3.innerText = response.num_anomalous_ips;
          if (el4) el4.innerText = response.num_blocked_ips;

          const tableBody = document.querySelector('#ip-table-body');
          if (!tableBody) return;

          tableBody.innerHTML = '';
          response.IPdata.forEach(ip => {
            const row = `
              <tr>
                <td class="w-30">
                  <div class="d-flex px-2 py-1 align-items-center">
                    <div class="ms-4">
                      <p class="text-xs font-weight-bold mb-0">IP:</p>
                      <h6 class="text-sm mb-0">${ip.ip}</h6>
                    </div>
                  </div>
                </td>
                <td>
                  <div class="text-center">
                    <p class="text-xs font-weight-bold mb-0">Número de pacotes (30seg):</p>
                    <h6 class="text-sm mb-0">${ip.num_packets_30s}</h6>
                  </div>
                </td>
                <td>
                  <div class="text-center">
                    <p class="text-xs font-weight-bold mb-0">Total pacotes:</p>
                    <h6 class="text-sm mb-0">${ip.num_packets}</h6>
                  </div>
                </td>
                <td class="align-middle text-sm">
                  <div class="col text-center">
                    <p class="text-xs font-weight-bold mb-0">Maligno:</p>
                    <h6 class="text-sm mb-0">${ip.maligno}</h6>
                  </div>
                </td>
              </tr>`;
            tableBody.innerHTML += row;
          });
        })
        .catch(err => console.error('Erro ao buscar /stats:', err));
    }
    
    updateStats(); // chama logo ao carregar a página
    setInterval(updateStats, 5000); // atualiza a cada 10 segundos
  </script>
  <!-- Github buttons -->
  <script async defer src="https://buttons.github.io/buttons.js"></script>
  <!-- Control Center for Soft Dashboard: parallax effects, scripts for the example pages etc -->
  <script src="../static/assets/js/argon-dashboard.min.js?v=2.1.0"></script>
</body>

</html>